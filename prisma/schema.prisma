// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ ENUMS ============

enum Role {
  ADMIN
  CENTER
  CITIZEN
}

enum ScheduleStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CenterType {
  HEALTH
  ADMINISTRATIVE
  EDUCATION
  SECURITY
  OTHER
}

// Bilhete de Identidade Angola - Specific Enums
enum TipoBI {
  NOVO
  RENOVACAO
  PERDA
  EXTRAVIO
  ATUALIZACAO_DADOS
}

enum BIScheduleStatus {
  AGENDADO
  CONFIRMADO
  BIOMETRIA_RECOLHIDA
  EM_PROCESSAMENTO
  PRONTO_RETIRADA
  RETIRADO
  REJEITADO
  CANCELADO
}

enum Provincia {
  BENGO
  BENGUELA
  BIES
  CABINDA
  CUANDO_CUBANGO
  CUANZA_NORTE
  CUANZA_SUL
  CUNENE
  HUAMBO
  HUILA
  KWANDO_KUBANGO
  KWANZA_NORTE
  KWANZA_SUL
  LUANDA
  LUNDA_NORTE
  LUNDA_SUL
  MALANJE
  MOXICO
  NAMIBE
  UIGE
  ZAI
}

enum DocumentType {
  RG
  CERTIDAO_NASCIMENTO
  COMPROVANTE_RESIDENCIA
  COMPROVANTE_ENDERECO
  FOTO_3X4
  OUTRO
}

// ============ MODELS ============

model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  name                  String
  password              String
  role                  Role     @default(CITIZEN)
  active                Boolean  @default(true)
  
  // BI-specific fields
  dataNascimento        DateTime?
  provinciaNascimento   Provincia?
  provinciaResidencia   Provincia?
  numeroBIAnterior      String?
  filiacao              String? // Parent names
  genero                String? // M, F, Outro
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  center                Center?
  schedules             Schedule[]
  documents             Document[]
  protocolos            Protocolo[]
  refreshTokens         RefreshToken[]

  @@index([email])
  @@index([role])
  @@index([provinciaResidencia])
}

model Center {
  id              String   @id @default(cuid())
  name            String
  description     String?
  type            CenterType
  address         String
  phone           String?
  email           String?
  provincia       Provincia
  openingTime     String   @default("08:00")
  closingTime     String   @default("17:00")
  attendanceDays  String   @default("MONDAY,TUESDAY,WEDNESDAY,THURSDAY,FRIDAY")
  capacidadeAgentos Int  @default(5)
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  userId    String  @unique
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedules Schedule[]

  @@index([userId])
  @@index([provincia])
}

model Schedule {
  id                String        @id @default(cuid())
  scheduledDate     DateTime
  slotNumber        Int?
  description       String?
  
  // Generic status (old)
  status            ScheduleStatus @default(PENDING)
  
  // BI-specific fields
  tipoBI            TipoBI?
  biStatus          BIScheduleStatus @default(AGENDADO)
  dataRetirada      DateTime?
  nbiEmitido        String? // Issued BI number
  
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  centerId  String
  center    Center    @relation(fields: [centerId], references: [id], onDelete: Cascade)
  documents Document[]
  protocolo Protocolo?

  @@index([userId])
  @@index([centerId])
  @@index([status])
  @@index([biStatus])
  @@index([scheduledDate])
  @@index([tipoBI])
}

model Document {
  id            String       @id @default(cuid())
  fileName      String
  fileUrl       String
  fileSize      Int? // bytes
  filePath      String? // local or cloud storage path
  mimeType      String? // application/pdf, image/jpeg, etc
  documentType  DocumentType
  uploadedAt    DateTime @default(now())
  
  // Relations
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  scheduleId String
  schedule  Schedule  @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scheduleId])
  @@index([documentType])
}

model Protocolo {
  id                String   @id @default(cuid())
  numeroProtocolo   String   @unique
  scheduleId        String   @unique
  schedule          Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  
  userId            String?
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Tracking
  statusAnterior    BIScheduleStatus
  statusAtual       BIScheduleStatus
  agenteProcessador String? // Admin/Center user who processed
  observacoes       String?
  
  registradoEm      DateTime @default(now())
  processadoEm      DateTime?
  createdAt         DateTime @default(now())

  @@index([numeroProtocolo])
  @@index([scheduleId])
  @@index([userId])
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
}
